{% extends "base.html" %}
{% block content %}
<h2><i class="fas fa-search me-2"></i>Data Explorer</h2>

<div class="card">
  <div class="card-body">
    <form id="filter-form" class="mb-4">
      <div class="row">
        <div class="col-md-6">
          <label for="indicator-type" class="form-label">
            <i class="fas fa-filter me-2"></i>Select Indicator Type:
          </label>
          <select id="indicator-type" class="form-select">
            <option value="all" selected>All Types</option>
            {% for type in indicator_types %}
            <option value="{{type}}">{{type}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">
            <i class="fas fa-info-circle me-2"></i>Quick Stats:
          </label>
          <div class="d-flex gap-3">
            <span class="badge bg-primary fs-6" id="total-count">0</span>
            <span class="badge bg-success fs-6" id="mitre-count">0</span>
            <span class="badge bg-warning fs-6" id="cve-count">0</span>
          </div>
        </div>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-striped table-hover" id="indicators-table">
        <thead class="table-dark">
          <tr>
            <th><i class="fas fa-hashtag me-1"></i>ID</th>
            <th><i class="fas fa-tag me-1"></i>Type</th>
            <th><i class="fas fa-code me-1"></i>Value</th>
            <th><i class="fas fa-file-text me-1"></i>Name</th>
            <th><i class="fas fa-database me-1"></i>Source</th>
            <th><i class="fas fa-exclamation-triangle me-1"></i>Severity</th>
            <th><i class="fas fa-calendar me-1"></i>Date Added</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="7" class="text-center text-muted">
              <i class="fas fa-spinner fa-spin me-2"></i>Loading data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function fetchIndicators(type) {
  try {
    const resp = await fetch(`/api/indicators?type=${type}`);
    const data = await resp.json();
    const tbody = document.querySelector("#indicators-table tbody");
    
    // Update counts
    const totalCount = data.length;
    const mitreCount = data.filter(item => item.type === 'MITRE Technique').length;
    const cveCount = data.filter(item => item.type === 'CVE Vulnerability').length;
    
    document.getElementById('total-count').textContent = totalCount;
    document.getElementById('mitre-count').textContent = mitreCount;
    document.getElementById('cve-count').textContent = cveCount;
    
    // Clear table
    tbody.innerHTML = "";
    
    if (data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-muted">
            <i class="fas fa-inbox me-2"></i>No indicators found
          </td>
        </tr>
      `;
      return;
    }
    
    // Populate table
    for (const item of data) {
      const severityClass = item.severity_score >= 8 ? 'text-danger' : 
                           item.severity_score >= 5 ? 'text-warning' : 'text-success';
      
      const row = `
        <tr>
          <td><span class="badge bg-secondary">${item.id}</span></td>
          <td>
            <span class="badge ${item.type === 'MITRE Technique' ? 'bg-primary' : 'bg-warning'}">
              ${item.type}
            </span>
          </td>
          <td><code>${item.value}</code></td>
          <td>
            <div class="fw-bold">${item.name}</div>
            <small class="text-muted">${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}</small>
          </td>
          <td>
            <span class="badge bg-info">${item.source}</span>
          </td>
          <td>
            <span class="badge ${severityClass}">${item.severity_score || 'N/A'}</span>
          </td>
          <td>${item.date_added || '-'}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', row);
    }
  } catch (error) {
    console.error('Error fetching indicators:', error);
    const tbody = document.querySelector("#indicators-table tbody");
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>Error loading data
        </td>
      </tr>
    `;
  }
}

document.getElementById('indicator-type').addEventListener('change', (e) => {
  fetchIndicators(e.target.value);
});

// Load initial data
fetchIndicators('all');
</script>
{% endblock %}
