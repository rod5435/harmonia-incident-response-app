{% extends "base.html" %}
{% block content %}
<h2><i class="fas fa-search me-2"></i>Data Explorer</h2>

<div class="card">
  <div class="card-body">
    <!-- Advanced Search Form -->
    <form id="advanced-search-form" class="mb-4">
      <div class="row">
        <!-- Global Search -->
        <div class="col-md-6 mb-3">
          <label for="global-search" class="form-label">
            <i class="fas fa-search me-2"></i>Global Search
          </label>
          <input type="text" id="global-search" class="form-control" 
                 placeholder="Search across all fields (name, description, value, source)">
        </div>
        
        <!-- Indicator Type Filter -->
        <div class="col-md-6 mb-3">
          <label for="indicator-type" class="form-label">
            <i class="fas fa-filter me-2"></i>Indicator Type
          </label>
          <select id="indicator-type" class="form-select">
            <option value="">All Types</option>
            {% for type in indicator_types %}
            <option value="{{type}}">{{type}}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <div class="row">
        <!-- Severity Range -->
        <div class="col-md-3 mb-3">
          <label for="severity-min" class="form-label">
            <i class="fas fa-exclamation-triangle me-2"></i>Min Severity
          </label>
          <input type="number" id="severity-min" class="form-control" 
                 min="0" max="10" step="0.1" placeholder="0.0">
        </div>
        
        <div class="col-md-3 mb-3">
          <label for="severity-max" class="form-label">
            <i class="fas fa-exclamation-triangle me-2"></i>Max Severity
          </label>
          <input type="number" id="severity-max" class="form-control" 
                 min="0" max="10" step="0.1" placeholder="10.0">
        </div>
        
        <!-- Date Range -->
        <div class="col-md-3 mb-3">
          <label for="date-from" class="form-label">
            <i class="fas fa-calendar me-2"></i>From Date
          </label>
          <input type="date" id="date-from" class="form-control">
        </div>
        
        <div class="col-md-3 mb-3">
          <label for="date-to" class="form-label">
            <i class="fas fa-calendar me-2"></i>To Date
          </label>
          <input type="date" id="date-to" class="form-control">
        </div>
      </div>
      
      <div class="row">
        <!-- Source Filter -->
        <div class="col-md-4 mb-3">
          <label for="source-filter" class="form-label">
            <i class="fas fa-database me-2"></i>Source
          </label>
          <select id="source-filter" class="form-select">
            <option value="">All Sources</option>
            {% for source in filter_options.sources %}
            <option value="{{source}}">{{source}}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Sort Options -->
        <div class="col-md-4 mb-3">
          <label for="sort-by" class="form-label">
            <i class="fas fa-sort me-2"></i>Sort By
          </label>
          <select id="sort-by" class="form-select">
            <option value="id">ID</option>
            <option value="name">Name</option>
            <option value="indicator_type">Type</option>
            <option value="severity_score">Severity</option>
            <option value="date_added">Date Added</option>
            <option value="source">Source</option>
          </select>
        </div>
        
        <div class="col-md-4 mb-3">
          <label for="sort-order" class="form-label">
            <i class="fas fa-sort-alpha-down me-2"></i>Sort Order
          </label>
          <select id="sort-order" class="form-select">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
          </select>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="row">
        <div class="col-12">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-search me-2"></i>Search
          </button>
          <button type="button" id="clear-filters" class="btn btn-outline-secondary me-2">
            <i class="fas fa-times me-2"></i>Clear Filters
          </button>
          <button type="button" id="save-search" class="btn btn-outline-primary">
            <i class="fas fa-save me-2"></i>Save Search
          </button>
        </div>
      </div>
    </form>

    <!-- Results Summary -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="d-flex gap-3">
          <span class="badge bg-primary fs-6" id="total-count">0</span>
          <span class="badge bg-success fs-6" id="mitre-count">0</span>
          <span class="badge bg-warning fs-6" id="cve-count">0</span>
          <span class="badge bg-info fs-6" id="urlhaus-count">0</span>
        </div>
      </div>
      <div class="col-md-6 text-end">
        <small class="text-muted" id="results-info">Showing 0 results</small>
      </div>
    </div>

    <!-- Results Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover" id="indicators-table">
        <thead class="table-dark">
          <tr>
            <th><i class="fas fa-hashtag me-1"></i>ID</th>
            <th><i class="fas fa-tag me-1"></i>Type</th>
            <th><i class="fas fa-code me-1"></i>Value</th>
            <th><i class="fas fa-file-text me-1"></i>Name</th>
            <th><i class="fas fa-database me-1"></i>Source</th>
            <th><i class="fas fa-exclamation-triangle me-1"></i>Severity</th>
            <th><i class="fas fa-calendar me-1"></i>Date Added</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="7" class="text-center text-muted">
              <i class="fas fa-search me-2"></i>Use the search form above to find indicators
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Search results pagination" id="pagination-nav" style="display: none;">
      <ul class="pagination justify-content-center">
        <li class="page-item" id="prev-page">
          <a class="page-link" href="#" tabindex="-1">Previous</a>
        </li>
        <li class="page-item" id="page-info">
          <span class="page-link">Page 1 of 1</span>
        </li>
        <li class="page-item" id="next-page">
          <a class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};

// Initialize the search form
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('date-to').value = today.toISOString().split('T')[0];
    
    // Handle drill-down from dashboard
    const urlParams = new URLSearchParams(window.location.search);
    const initialType = urlParams.get('type');
    const initialSource = urlParams.get('source');
    
    if (initialType) {
        document.getElementById('indicator-type').value = initialType;
        // Show a notification about the drill-down
        showDrillDownNotification(initialType);
    }
    
    if (initialSource) {
        document.getElementById('source-filter').value = initialSource;
        if (!initialType) {
            showDrillDownNotification(initialSource, 'source');
        }
    }
    
    // Load initial data
    performSearch();
});

function showDrillDownNotification(filterValue, filterType = 'type') {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show';
    notification.innerHTML = `
        <i class="fas fa-filter me-2"></i>
        <strong>Drill-down Active:</strong> Showing results filtered by ${filterType === 'source' ? 'source' : 'type'} "${filterValue}"
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the card body
    const cardBody = document.querySelector('.card-body');
    cardBody.insertBefore(notification, cardBody.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Handle form submission
document.getElementById('advanced-search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    performSearch();
});

// Clear filters
document.getElementById('clear-filters').addEventListener('click', function() {
    document.getElementById('advanced-search-form').reset();
    currentPage = 1;
    performSearch();
});

// Save search (placeholder for future feature)
document.getElementById('save-search').addEventListener('click', function() {
    alert('Save search feature coming soon!');
});

// Pagination handlers
document.getElementById('prev-page').addEventListener('click', function(e) {
    e.preventDefault();
    if (currentPage > 1) {
        currentPage--;
        performSearch();
    }
});

document.getElementById('next-page').addEventListener('click', function(e) {
    e.preventDefault();
    currentPage++;
    performSearch();
});

function performSearch() {
    const searchParams = new URLSearchParams();
    
    // Only add non-empty values to the search parameters
    const globalSearch = document.getElementById('global-search').value.trim();
    if (globalSearch) {
        searchParams.append('search', globalSearch);
    }
    
    const indicatorType = document.getElementById('indicator-type').value.trim();
    if (indicatorType) {
        searchParams.append('type', indicatorType);
    }
    
    const severityMin = document.getElementById('severity-min').value.trim();
    if (severityMin) {
        searchParams.append('severity_min', severityMin);
    }
    
    const severityMax = document.getElementById('severity-max').value.trim();
    if (severityMax) {
        searchParams.append('severity_max', severityMax);
    }
    
    const dateFrom = document.getElementById('date-from').value.trim();
    if (dateFrom) {
        searchParams.append('date_from', dateFrom);
    }
    
    const dateTo = document.getElementById('date-to').value.trim();
    if (dateTo) {
        searchParams.append('date_to', dateTo);
    }
    
    const source = document.getElementById('source-filter').value.trim();
    if (source) {
        searchParams.append('source', source);
    }
    
    // Always include these parameters
    searchParams.append('sort_by', document.getElementById('sort-by').value);
    searchParams.append('sort_order', document.getElementById('sort-order').value);
    searchParams.append('page', currentPage);
    searchParams.append('per_page', 20);
    
    // Show loading state
    const tbody = document.querySelector("#indicators-table tbody");
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center text-muted">
                <i class="fas fa-spinner fa-spin me-2"></i>Searching...
            </td>
        </tr>
    `;
    
    fetch(`/api/advanced-search?${searchParams}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            displayResults(data);
        })
        .catch(error => {
            console.error('Search error:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Error loading data
                    </td>
                </tr>
            `;
        });
}

function displayResults(data) {
    const tbody = document.querySelector("#indicators-table tbody");
    
    // Update counts
    const totalCount = data.total;
    const mitreCount = data.items.filter(item => item.type === 'MITRE Technique').length;
    const cveCount = data.items.filter(item => item.type === 'CVE Vulnerability').length;
    const urlhausCount = data.items.filter(item => item.type === 'Malicious URL').length;
    
    document.getElementById('total-count').textContent = totalCount;
    document.getElementById('mitre-count').textContent = mitreCount;
    document.getElementById('cve-count').textContent = cveCount;
    document.getElementById('urlhaus-count').textContent = urlhausCount;
    
    // Update results info
    const start = ((data.current_page - 1) * data.per_page) + 1;
    const end = Math.min(start + data.items.length - 1, totalCount);
    document.getElementById('results-info').textContent = 
        `Showing ${start}-${end} of ${totalCount} results`;
    
    // Clear table
    tbody.innerHTML = "";
    
    if (data.items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox me-2"></i>No indicators found matching your criteria
                </td>
            </tr>
        `;
        document.getElementById('pagination-nav').style.display = 'none';
        return;
    }
    
    // Populate table
    for (const item of data.items) {
        const severityClass = item.severity_score >= 8 ? 'text-danger' : 
                             item.severity_score >= 5 ? 'text-warning' : 'text-success';
        
        const typeBadgeClass = item.type === 'MITRE Technique' ? 'bg-primary' : 
                              item.type === 'CVE Vulnerability' ? 'bg-warning' : 'bg-info';
        
        const row = `
            <tr>
                <td><span class="badge bg-secondary">${item.id}</span></td>
                <td>
                    <span class="badge ${typeBadgeClass}">
                        ${item.type}
                    </span>
                </td>
                <td><code>${item.value}</code></td>
                <td>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">${item.description.substring(0, 100)}${item.description.length > 100 ? '...' : ''}</small>
                </td>
                <td>
                    <span class="badge bg-info">${item.source}</span>
                </td>
                <td>
                    <span class="badge ${severityClass}">${item.severity_score || 'N/A'}</span>
                </td>
                <td>${item.date_added || '-'}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    }
    
    // Update pagination
    updatePagination(data);
}

function updatePagination(data) {
    const paginationNav = document.getElementById('pagination-nav');
    const prevPage = document.getElementById('prev-page');
    const nextPage = document.getElementById('next-page');
    const pageInfo = document.getElementById('page-info');
    
    if (data.pages <= 1) {
        paginationNav.style.display = 'none';
        return;
    }
    
    paginationNav.style.display = 'block';
    
    // Update page info
    pageInfo.innerHTML = `<span class="page-link">Page ${data.current_page} of ${data.pages}</span>`;
    
    // Update previous button
    prevPage.classList.toggle('disabled', !data.has_prev);
    
    // Update next button
    nextPage.classList.toggle('disabled', !data.has_next);
}

// Auto-search on filter changes (with debounce)
let searchTimeout;
function debouncedSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        currentPage = 1;
        performSearch();
    }, 500);
}

// Add event listeners for auto-search
['indicator-type', 'source-filter', 'sort-by', 'sort-order'].forEach(id => {
    document.getElementById(id).addEventListener('change', debouncedSearch);
});

['severity-min', 'severity-max'].forEach(id => {
    document.getElementById(id).addEventListener('input', debouncedSearch);
});

['date-from', 'date-to'].forEach(id => {
    document.getElementById(id).addEventListener('change', debouncedSearch);
});
</script>
{% endblock %}
